(function webpackUniversalModuleDefinition(root,factory){if(typeof exports==="object"&&typeof module==="object")module.exports=factory();else if(typeof define==="function"&&define.amd)define([],factory);else{var a=factory();for(var i in a)(typeof exports==="object"?exports:root)[i]=a[i]}})(this,function(){return(()=>{"use strict";var __webpack_require__={};(()=>{__webpack_require__.d=(exports2,definition)=>{for(var key in definition){if(__webpack_require__.o(definition,key)&&!__webpack_require__.o(exports2,key)){Object.defineProperty(exports2,key,{enumerable:true,get:definition[key]})}}}})();(()=>{__webpack_require__.o=(obj,prop)=>Object.prototype.hasOwnProperty.call(obj,prop)})();(()=>{__webpack_require__.r=exports2=>{if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(exports2,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(exports2,"__esModule",{value:true})}})();var __webpack_exports__={};__webpack_require__.r(__webpack_exports__);__webpack_require__.d(__webpack_exports__,{"EventType":()=>EventType,"FeatureFlagType":()=>FeatureFlagType,"FeatureFlagUpdateOperation":()=>FeatureFlagUpdateOperation,"Ffc":()=>Ffc,"InsightType":()=>InsightType,"StreamResponseEventType":()=>StreamResponseEventType,"UrlMatchType":()=>types_UrlMatchType,"default":()=>src});;var EventEmitter=function(){function EventEmitter2(events){this.events=events||{}}EventEmitter2.prototype.subscribe=function(name,cb){var _this=this;(this.events[name]||(this.events[name]=[])).push(cb);return{unsubscribe:function(){return _this.events[name]&&_this.events[name].splice(_this.events[name].indexOf(cb)>>>0,1)}}};EventEmitter2.prototype.emit=function(name){var args=[];for(var _i=1;_i<arguments.length;_i++){args[_i-1]=arguments[_i]}(this.events[name]||[]).forEach(function(fn){return fn.apply(void 0,args)})};return EventEmitter2}();var eventHub=new EventEmitter;;var debugMode=false;var logger_logger={logDebug:function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}if(debugMode){console.log.apply(console,args)}},log:function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}console.log.apply(console,args)}};;var insightsFlushTopic="insights.flush";var featureFlagEvaluatedTopic="featureflag.evaluated.topic";var featureFlagEvaluatedBufferTopic="featureflag.evaluated.buffer.topic";var websocketReconnectTopic="network.websocket.reconnect";var debugModeQueryStr="debugmode";var insightsTopic="insights.topic";var devModeEventName="ffcdevmodechange";var devModeStorageKey="ffcdevmode";var devModeBtnId="ff-devmode-btn";var devModeQueryStr="devmode";var WebSocket={OPEN:1};;var InsightType;(function(InsightType2){InsightType2[InsightType2["featureFlagUsage"]=1]="featureFlagUsage";InsightType2[InsightType2["customEvent"]=2]="customEvent";InsightType2[InsightType2["pageView"]=3]="pageView";InsightType2[InsightType2["click"]=4]="click"})(InsightType||(InsightType={}));var StreamResponseEventType;(function(StreamResponseEventType2){StreamResponseEventType2["full"]="full";StreamResponseEventType2["patch"]="patch"})(StreamResponseEventType||(StreamResponseEventType={}));var FeatureFlagUpdateOperation;(function(FeatureFlagUpdateOperation2){FeatureFlagUpdateOperation2["update"]="update";FeatureFlagUpdateOperation2["createDevData"]="createDevData";FeatureFlagUpdateOperation2["devDataCreated"]="devDataCreated"})(FeatureFlagUpdateOperation||(FeatureFlagUpdateOperation={}));var FeatureFlagType;(function(FeatureFlagType2){FeatureFlagType2[FeatureFlagType2["Classic"]=1]="Classic";FeatureFlagType2[FeatureFlagType2["Pretargeted"]=2]="Pretargeted"})(FeatureFlagType||(FeatureFlagType={}));var EventType;(function(EventType2){EventType2[EventType2["Custom"]=1]="Custom";EventType2[EventType2["PageView"]=2]="PageView";EventType2[EventType2["Click"]=3]="Click"})(EventType||(EventType={}));var types_UrlMatchType;(function(UrlMatchType2){UrlMatchType2[UrlMatchType2["Substring"]=1]="Substring"})(types_UrlMatchType||(types_UrlMatchType={}));;const localStorage={getItem:function(key){try{return wx.getStorageSync(key)}catch(e){logger_logger.logDebug(e);return""}},setItem:function(key,data){try{wx.setStorageSync(key,data)}catch(e){logger_logger.logDebug(e)}},removeItem:function(key){try{wx.removeStorageSync("key")}catch(e){logger_logger.logDebug(e)}}};;var DataStoreStorageKey="ffcdatastore";var Store=function(){function Store2(){var _this=this;this._isDevMode=false;this._userId=null;this._store={featureFlags:{}};eventHub.subscribe("devmode_ff_".concat(FeatureFlagUpdateOperation.update),function(data){var updatedFfs=Object.keys(data).map(function(key){var changes=data[key];var ff=_this._store.featureFlags[key];var updatedFf=Object.assign({},ff,{variation:changes["newValue"],timestamp:Date.now()});return updatedFf}).reduce(function(res,curr){res.featureFlags[curr.id]=Object.assign({},curr,{timestamp:Date.now()});return res},{featureFlags:{}});_this.updateStorageBulk(updatedFfs,"".concat(DataStoreStorageKey,"_dev_").concat(_this._userId),false);_this._loadFromStorage()});eventHub.subscribe("devmode_ff_".concat(FeatureFlagUpdateOperation.createDevData),function(){localStorage.removeItem("".concat(DataStoreStorageKey,"_dev_").concat(_this._userId));_this._loadFromStorage();eventHub.emit("devmode_ff_".concat(FeatureFlagUpdateOperation.devDataCreated),_this._store.featureFlags)})}Object.defineProperty(Store2.prototype,"userId",{set:function(id){this._userId=id;this._loadFromStorage()},enumerable:false,configurable:true});Object.defineProperty(Store2.prototype,"isDevMode",{get:function(){return this._isDevMode},set:function(devMode){this._isDevMode=devMode;this._loadFromStorage()},enumerable:false,configurable:true});Store2.prototype.getFeatureFlag=function(key){return this._store.featureFlags[key]};Store2.prototype.getVariation=function(key){var featureFlag=this._store.featureFlags[key];if(!!featureFlag){eventHub.emit(featureFlagEvaluatedTopic,{insightType:InsightType.featureFlagUsage,id:featureFlag.id,timestamp:Date.now(),sendToExperiment:featureFlag.sendToExperiment,variation:featureFlag.variationOptions.find(function(o){return o.value===featureFlag.variation})})}return featureFlag===null||featureFlag===void 0?void 0:featureFlag.variation};Store2.prototype.setFullData=function(data){if(!this._isDevMode){this._store={featureFlags:{}};this._dumpToStorage(this._store)}this.updateBulkFromRemote(data)};Store2.prototype.getFeatureFlags=function(){return this._store.featureFlags};Store2.prototype.updateStorageBulk=function(data,storageKey,onlyInsertNewElement){var dataStoreStr=localStorage.getItem(storageKey);var store2=null;try{if(dataStoreStr&&dataStoreStr.trim().length>0){store2=JSON.parse(dataStoreStr)}else if(this.isDevMode||storageKey.indexOf("_dev_")===-1){store2={featureFlags:{}}}}catch(err){logger_logger.logDebug("error while loading local data store: ".concat(storageKey)+err)}if(!!store2){var featureFlags_1=data.featureFlags;Object.keys(featureFlags_1).forEach(function(id){var remoteFf=featureFlags_1[id];var localFf=store2.featureFlags[id];var predicate=!localFf||!onlyInsertNewElement&&remoteFf.timestamp>localFf.timestamp;if(predicate){store2.featureFlags[remoteFf.id]=Object.assign({},remoteFf)}});this._dumpToStorage(store2,storageKey)}};Store2.prototype.updateBulkFromRemote=function(data){var storageKey="".concat(DataStoreStorageKey,"_").concat(this._userId);var devStorageKey="".concat(DataStoreStorageKey,"_dev_").concat(this._userId);this.updateStorageBulk(data,storageKey,false);this.updateStorageBulk(data,devStorageKey,true);this._loadFromStorage()};Store2.prototype._emitUpdateEvents=function(updatedFeatureFlags){if(updatedFeatureFlags.length>0){updatedFeatureFlags.forEach(function(_a){var id=_a.id,operation=_a.operation,data=_a.data;return eventHub.emit("ff_".concat(operation,":").concat(data.id),data)});eventHub.emit("ff_".concat(FeatureFlagUpdateOperation.update),updatedFeatureFlags.map(function(item){return item.data}))}};Store2.prototype._dumpToStorage=function(store2,localStorageKey){if(store2){var storageKey_1=localStorageKey||"".concat(DataStoreStorageKey,"_").concat(this._userId);localStorage.setItem(storageKey_1,JSON.stringify(store2));return}var storageKey=this._isDevMode?"".concat(DataStoreStorageKey,"_dev_").concat(this._userId):"".concat(DataStoreStorageKey,"_").concat(this._userId);localStorage.setItem(storageKey,JSON.stringify(this._store))};Store2.prototype._loadFromStorage=function(){var _this=this;try{var storageKey=this._isDevMode?"".concat(DataStoreStorageKey,"_dev_").concat(this._userId):"".concat(DataStoreStorageKey,"_").concat(this._userId);var dataStoreStr=localStorage.getItem(storageKey);var shouldDumpToStorage=false;if(this._isDevMode){try{var devData=JSON.parse(dataStoreStr);if(devData===null||Object.keys(devData.featureFlags).length===0){shouldDumpToStorage=true;dataStoreStr=localStorage.getItem("".concat(DataStoreStorageKey,"_").concat(this._userId))}}catch(err){shouldDumpToStorage=true;dataStoreStr=localStorage.getItem("".concat(DataStoreStorageKey,"_").concat(this._userId))}}if(dataStoreStr&&dataStoreStr.trim().length>0){var storageData_1=JSON.parse(dataStoreStr);var updatedFeatureFlags=Object.keys(storageData_1.featureFlags).filter(function(key){var storageFf=storageData_1.featureFlags[key];var ff=_this._store.featureFlags[key];return!ff||storageFf.variation!==ff.variation}).map(function(key){var storageFf=storageData_1.featureFlags[key];var ff=_this._store.featureFlags[key];return{id:key,operation:FeatureFlagUpdateOperation.update,sendToExperiment:storageFf.sendToExperiment,data:{id:key,oldValue:ff===null||ff===void 0?void 0:ff.variation,newValue:storageFf.variation}}});this._store=storageData_1;this._emitUpdateEvents(updatedFeatureFlags)}else{this._store={featureFlags:{}}}if(shouldDumpToStorage){this._dumpToStorage()}}catch(err){logger_logger.logDebug("error while loading local data store: "+err)}};return Store2}();const store=new Store;;function ffcguid(){var ffcHomePageGuid=localStorage.getItem("ffc-guid");if(ffcHomePageGuid){return ffcHomePageGuid}else{var id=uuid();localStorage.setItem("ffc-guid",id);return id}}function uuid(){var uuid2="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)});return uuid2}function validateUser(user){if(!user){return"user must be defined"}var id=user.id,userName=user.userName;if(id===void 0||id===null||id.trim()===""){return"user id is mandatory"}if(userName===void 0||userName===null||userName.trim()===""){return"userName is mandatory"}return null}function validateOption(option){if(option===void 0||option===null){return"option is mandatory"}var secret=option.secret,anonymous=option.anonymous,user=option.user,enableDataSync=option.enableDataSync;if(enableDataSync&&(secret===void 0||secret===null||secret.trim()==="")){return"secret is mandatory in option"}if(!!anonymous===false&&!user){return"user is mandatory when not using anonymous user"}if(user){return validateUser(user)}return null}function makeElementDraggable(el){el.addEventListener("mousedown",function(e){var offsetX=e.clientX-parseInt(window.getComputedStyle(this).left);var offsetY=e.clientY-parseInt(window.getComputedStyle(this).top);function mouseMoveHandler(e2){e2.preventDefault();el.style.top=e2.clientY-offsetY+"px";el.style.left=e2.clientX-offsetX+"px"}function reset(){document.removeEventListener("mousemove",mouseMoveHandler);document.removeEventListener("mouseup",reset)}document.addEventListener("mousemove",mouseMoveHandler);document.addEventListener("mouseup",reset)})}function addCss(element,style){for(var property in style){element.style[property]=style[property]}}var alphabet={"0":"Q","1":"B","2":"W","3":"S","4":"P","5":"H","6":"D","7":"X","8":"Z","9":"U"};function encodeNumber(param,length){var s="000000000000"+param;var numberWithLeadingZeros=s.slice(s.length-length);return numberWithLeadingZeros.split("").map(function(n){return alphabet[n]}).join("")}function generateConnectionToken(text){text=text.replace(/=*$/,"");var timestamp=Date.now();var timestampCode=encodeNumber(timestamp,timestamp.toString().length);var start=Math.max(Math.floor(Math.random()*text.length),2);return"".concat(encodeNumber(start,3)).concat(encodeNumber(timestampCode.length,2)).concat(text.slice(0,start)).concat(timestampCode).concat(text.slice(start))}function isUrlMatch(matchType,url){var current_page_url=window.location.href;if(url===null||url===void 0||url===""){return true}switch(matchType){case UrlMatchType.Substring:return current_page_url.includes(url);default:return false}}function groupBy(xs,key){return xs.reduce(function(rv,x){(rv[x[key]]=rv[x[key]]||[]).push(x);return rv},{})};function extractCSS(css){return css.trim().replace(/(?:\r\n|\r|\n)/g,";").replace(/\w*([\W\w])+\{/g,"").replace(/(?:\{|\})/g,"").split(";").filter(function(c){return c.trim()!==""}).map(function(c){var style=c.split(":");if(style.length===2){return{name:style[0].trim(),value:style[1].trim()}}return{name:"",value:""}}).filter(function(s){return s.name!==""&&s.value!==""})};var __assign=function(){__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return __assign.apply(this,arguments)};var __awaiter=function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var __generator=function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var __spreadArray=function(to,from,pack){if(pack||arguments.length===2)for(var i=0,l=from.length,ar;i<l;i++){if(ar||!(i in from)){if(!ar)ar=Array.prototype.slice.call(from,0,i);ar[i]=from[i]}}return to.concat(ar||Array.prototype.slice.call(from))};var API_CALL_RESULTS={};var FOOT_PRINTS=[];var _throttleWait=5*60*1e3;var ThrottleUtil=function(){function ThrottleUtil2(){this._key=uuid()}ThrottleUtil2.prototype.setKey=function(key){this._key=key||this._key};ThrottleUtil2.prototype.throttle=function(fn,ms){var timer=0;return function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}clearTimeout(timer);timer=setTimeout(fn.bind.apply(fn,__spreadArray([null],args,false)),ms||0)}};ThrottleUtil2.prototype.throttleAsync=function(callback){var _this=this;var waiting=false;var getFootprint=function(args){var params=args.map(function(arg){if(typeof arg==="object"&&typeof arg!=="function"&&arg!==null){if(Array.isArray(arg)){return arg.map(function(a){return __assign(__assign({},a),{timestamp:null})})}else{return __assign(__assign({},arg),{timestamp:null})}}return arg});return _this._key+JSON.stringify(params)};return function(){var args=[];for(var _i=0;_i<arguments.length;_i++){args[_i]=arguments[_i]}return __awaiter(this,void 0,void 0,function(){var footprint,idx,_a,_b;return __generator(this,function(_c){switch(_c.label){case 0:footprint=getFootprint(args);idx=FOOT_PRINTS.findIndex(function(f){return f===footprint});if(!(!waiting||idx===-1))return[3,2];waiting=true;if(idx===-1){FOOT_PRINTS.push(footprint)}_a=API_CALL_RESULTS;_b=footprint;return[4,callback.apply(null,args)];case 1:_a[_b]=_c.sent();setTimeout(function(){waiting=false},_throttleWait);_c.label=2;case 2:return[2,API_CALL_RESULTS[footprint]]}})})}};return ThrottleUtil2}();const throttleutil=new ThrottleUtil;;var network_service_assign=function(){network_service_assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return network_service_assign.apply(this,arguments)};var network_service_awaiter=function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var network_service_generator=function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var socketConnectionIntervals=[250,500,1e3,2e3,4e3,8e3,1e4,3e4];var retryCounter=0;var NetworkService=function(){function NetworkService2(){var _this=this;this.retryCounter=0;this.sendInsights=throttleutil.throttleAsync(function(data){return network_service_awaiter(_this,void 0,void 0,function(){var payload,err_1;var _this2=this;return network_service_generator(this,function(_a){switch(_a.label){case 0:if(!this.secret||!this.user||!data||data.length===0){return[2]}_a.label=1;case 1:_a.trys.push([1,3,,4]);payload=[{user:this.__getUserInfo(),userVariations:data.filter(function(d){return d.insightType===InsightType.featureFlagUsage}).map(function(v){return{featureFlagKeyName:v.id,sendToExperiment:v.sendToExperiment,timestamp:v.timestamp,variation:{localId:v.variation.id,variationValue:v.variation.value}}}),metrics:data.filter(function(d){return d.insightType!==InsightType.featureFlagUsage}).map(function(d){return{route:location.pathname,numericValue:d.numericValue===null||d.numericValue===void 0?1:d.numericValue,appType:_this2.appType,eventName:d.eventName,type:d.type}})}];return[4,post("".concat(this.api,"/api/public/track"),payload,{envSecret:this.secret})];case 2:_a.sent();return[3,4];case 3:err_1=_a.sent();logger_logger.logDebug(err_1);return[3,4];case 4:return[2]}})})})}NetworkService2.prototype.init=function(api,secret,appType){this.api=api;this.secret=secret;this.appType=appType};NetworkService2.prototype.identify=function(user){var _a,_b,_c;if(((_a=this.user)===null||_a===void 0?void 0:_a.id)!==user.id){(_b=this.socket)===null||_b===void 0?void 0:_b.close(4003,"identify, do not reconnect");this.socket=void 0;this.user=network_service_assign({},user);throttleutil.setKey((_c=this.user)===null||_c===void 0?void 0:_c.id)}};NetworkService2.prototype.createConnection=function(timestamp,onMessage){var _a;var that=this;if(that.socket){onMessage({});return}var startTime=Date.now();var url=((_a=this.api)===null||_a===void 0?void 0:_a.replace(/^http/,"ws"))+"/streaming?type=client&token=".concat(generateConnectionToken(this.secret));that.socket=wx.connectSocket({url});function sendPingMessage(socket){var payload={messageType:"ping",data:null};setTimeout(function(){try{if((socket===null||socket===void 0?void 0:socket.readyState)===WebSocket.OPEN){socket.send(that.formatSendDataForSocket(payload));sendPingMessage(socket)}else{logger_logger.logDebug("socket closed at ".concat(new Date))}}catch(err){logger_logger.logDebug(err)}},18e3)}that.socket.onOpen(function(header,profile){var _a2=that.user,userName=_a2.userName,email=_a2.email,country=_a2.country,id=_a2.id,customizedProperties=_a2.customizedProperties;var payload={messageType:"data-sync",data:{user:{userName,email,country,userKeyId:id,customizedProperties},timestamp}};logger_logger.logDebug("Connection time: ".concat(Date.now()-startTime," ms"));that.socket.send(that.formatSendDataForSocket(payload));sendPingMessage(that.socket)});that.socket.onClose(function(code,reason){logger_logger.logDebug("close");if(code===4003){return}var waitTime=socketConnectionIntervals[Math.min(that.retryCounter++,socketConnectionIntervals.length)];setTimeout(function(){return eventHub.emit(websocketReconnectTopic,{})},waitTime);logger_logger.logDebug(waitTime)});that.socket.onError(function(errMsg){logger_logger.logDebug(errMsg)});that.socket.onMessage(function(event){var message=JSON.parse(event.data);if(message.messageType==="data-sync"){onMessage(message.data);if(message.data.featureFlags.length>0){logger_logger.logDebug("socket push update time(ms): ",Date.now()-message.data.featureFlags[0].timestamp)}}})};NetworkService2.prototype.__getUserInfo=function(){var _a=this.user,userName=_a.userName,email=_a.email,country=_a.country,id=_a.id,customizedProperties=_a.customizedProperties;return{userName,email,country,keyId:id,customizedProperties}};NetworkService2.prototype.formatSendDataForSocket=function(message){return{data:JSON.stringify(message),success:function(){return logger_logger.logDebug("websocket send success")},fail:function(event){return logger_logger.log("websocket error when sending message: ".concat(event))}}};NetworkService2.prototype.getActiveExperimentMetricSettings=function(){return network_service_awaiter(this,void 0,void 0,function(){return network_service_generator(this,function(_a){return[2,[]]})})};NetworkService2.prototype.getZeroCodeSettings=function(){return network_service_awaiter(this,void 0,void 0,function(){return network_service_generator(this,function(_a){return[2,[]]})})};return NetworkService2}();var networkService=new NetworkService;function post(url,data,headers){if(url===void 0){url=""}if(data===void 0){data={}}if(headers===void 0){headers={}}return network_service_awaiter(this,void 0,void 0,function(){return network_service_generator(this,function(_a){switch(_a.label){case 0:return[4,new Promise(function(resolve){wx.request({url,method:"POST",data,header:Object.assign({"Content-Type":"application/json"},headers),fail:function(res){resolve({});logger_logger.logDebug(res)},success:function(res){resolve(res.status===200?res:{})}})})];case 1:return[2,_a.sent()]}})})}function get(url,headers){if(url===void 0){url=""}if(headers===void 0){headers={}}return network_service_awaiter(this,void 0,void 0,function(){return network_service_generator(this,function(_a){switch(_a.label){case 0:return[4,new Promise(function(resolve){wx.request({url,method:"GET",header:Object.assign({"Content-Type":"application/json"},headers),fail:function(res){resolve({});logger.logDebug(res)},success:function(res){resolve(res.status===200?res:{})}})})];case 1:return[2,_a.sent()]}})})};var queue_spreadArray=function(to,from,pack){if(pack||arguments.length===2)for(var i=0,l=from.length,ar;i<l;i++){if(ar||!(i in from)){if(!ar)ar=Array.prototype.slice.call(from,0,i);ar[i]=from[i]}}return to.concat(ar||Array.prototype.slice.call(from))};var Queue=function(){function Queue2(flushLimit,arriveflushLimitTopic){if(flushLimit===void 0){flushLimit=0}if(arriveflushLimitTopic===void 0){arriveflushLimitTopic=""}this.flushLimit=flushLimit;this.arriveflushLimitTopic=arriveflushLimitTopic;this.queue=[]}Queue2.prototype.add=function(element){this.queue.push(element);if(this.flushLimit>0&&this.queue.length>=this.flushLimit){eventHub.emit(this.arriveflushLimitTopic,{})}};Queue2.prototype.flush=function(){var allElements=queue_spreadArray([],this.queue,true);this.queue=[];return allElements};return Queue2}();;var ffc_assign=function(){ffc_assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};return ffc_assign.apply(this,arguments)};var ffc_awaiter=function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value)})}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})};var ffc_generator=function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1]},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this}),g;function verb(n){return function(v){return step([n,v])}}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break}if(t[2])_.ops.pop();_.trys.pop();continue}op=body.call(thisArg,_)}catch(e){op=[6,e];y=0}finally{f=t=0}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true}}};var ffc_spreadArray=function(to,from,pack){if(pack||arguments.length===2)for(var i=0,l=from.length,ar;i<l;i++){if(ar||!(i in from)){if(!ar)ar=Array.prototype.slice.call(from,0,i);ar[i]=from[i]}}return to.concat(ar||Array.prototype.slice.call(from))};function createorGetAnonymousUser(){var sessionId=ffcguid();return{userName:sessionId,email:"".concat(sessionId,"@anonymous.com"),id:sessionId}}function mapFeatureFlagsToFeatureFlagBaseList(featureFlags){return Object.keys(featureFlags).map(function(cur){var _a=featureFlags[cur],id=_a.id,variation=_a.variation;return{id,variation}})}var Ffc=function(){function Ffc2(){var _this=this;this._readyEventEmitted=false;this._insightsQueue=new Queue(1,insightsFlushTopic);this._featureFlagEvaluationBuffer=new Queue;this._option={secret:"",api:"https://api.featureflag.co",enableDataSync:true,appType:"javascript"};this._readyPromise=new Promise(function(resolve,reject){_this.on("ready",function(){var featureFlags=store.getFeatureFlags();resolve(mapFeatureFlagsToFeatureFlagBaseList(featureFlags));if(_this._option.enableDataSync){var buffered=_this._featureFlagEvaluationBuffer.flush().map(function(f){var featureFlag=featureFlags[f.id];if(!featureFlag){logger_logger.log("Called unexisting feature flag: ".concat(f.id));return null}var variation=featureFlag.variationOptions.find(function(o){return o.value===f.variationValue});if(!variation){logger_logger.log("Sent buffered insight for feature flag: ".concat(f.id," with unexisting default variation: ").concat(f.variationValue))}else{logger_logger.logDebug("Sent buffered insight for feature flag: ".concat(f.id," with variation: ").concat(variation.value))}return{insightType:InsightType.featureFlagUsage,id:featureFlag.id,timestamp:f.timestamp,sendToExperiment:featureFlag.sendToExperiment,variation:variation||{id:-1,value:f.variationValue}}});networkService.sendInsights(buffered.filter(function(x){return!!x}))}})});eventHub.subscribe(websocketReconnectTopic,function(){return ffc_awaiter(_this,void 0,void 0,function(){var err_1;return ffc_generator(this,function(_a){switch(_a.label){case 0:_a.trys.push([0,2,,3]);return[4,this.dataSync()];case 1:_a.sent();if(!this._readyEventEmitted){this._readyEventEmitted=true;eventHub.emit("ready",mapFeatureFlagsToFeatureFlagBaseList(store.getFeatureFlags()))}return[3,3];case 2:err_1=_a.sent();logger_logger.log("data sync error",err_1);return[3,3];case 3:return[2]}})})});eventHub.subscribe(featureFlagEvaluatedBufferTopic,function(data){_this._featureFlagEvaluationBuffer.add(data)});eventHub.subscribe(insightsFlushTopic,function(){if(_this._option.enableDataSync){networkService.sendInsights(_this._insightsQueue.flush())}});eventHub.subscribe(featureFlagEvaluatedTopic,function(data){_this._insightsQueue.add(data)});eventHub.subscribe(insightsTopic,function(data){_this._insightsQueue.add(data)})}Ffc2.prototype.on=function(name,cb){eventHub.subscribe(name,cb)};Ffc2.prototype.waitUntilReady=function(){return this._readyPromise};Ffc2.prototype.init=function(option){var _a;return ffc_awaiter(this,void 0,void 0,function(){var validateOptionResult;return ffc_generator(this,function(_b){switch(_b.label){case 0:validateOptionResult=validateOption(option);if(validateOptionResult!==null){logger_logger.log(validateOptionResult);return[2]}this._option=Object.assign({},this._option,option,{api:(_a=option.api||this._option.api)===null||_a===void 0?void 0:_a.replace(/\/$/,"")});if(this._option.enableDataSync){networkService.init(this._option.api,this._option.secret,this._option.appType)}return[4,this.identify(option.user||createorGetAnonymousUser())];case 1:_b.sent();return[2]}})})};Ffc2.prototype.identify=function(user){return ffc_awaiter(this,void 0,void 0,function(){var validateUserResult;return ffc_generator(this,function(_a){switch(_a.label){case 0:validateUserResult=validateUser(user);if(validateUserResult!==null){logger_logger.log(validateUserResult);return[2]}this._option.user=Object.assign({},user);store.userId=this._option.user.id;networkService.identify(this._option.user);return[4,this.bootstrap()];case 1:_a.sent();return[2]}})})};Ffc2.prototype.logout=function(){return ffc_awaiter(this,void 0,void 0,function(){var anonymousUser;return ffc_generator(this,function(_a){switch(_a.label){case 0:anonymousUser=createorGetAnonymousUser();return[4,this.identify(anonymousUser)];case 1:_a.sent();return[2,anonymousUser]}})})};Ffc2.prototype.bootstrap=function(featureFlags){return ffc_awaiter(this,void 0,void 0,function(){var data,err_2;return ffc_generator(this,function(_a){switch(_a.label){case 0:featureFlags=featureFlags||this._option.bootstrap;if(featureFlags&&featureFlags.length>0){data={featureFlags:featureFlags.reduce(function(res,curr){var id=curr.id,variation=curr.variation,timestamp=curr.timestamp,variationOptions=curr.variationOptions,sendToExperiment=curr.sendToExperiment;res[id]={id,variation,timestamp,variationOptions,sendToExperiment};return res},{})};store.setFullData(data);logger_logger.logDebug("bootstrapped with full data")}if(!this._option.enableDataSync)return[3,5];_a.label=1;case 1:_a.trys.push([1,3,,4]);return[4,this.dataSync()];case 2:_a.sent();return[3,4];case 3:err_2=_a.sent();logger_logger.log("data sync error",err_2);return[3,4];case 4:store.isDevMode=!!store.isDevMode;_a.label=5;case 5:if(!this._readyEventEmitted){this._readyEventEmitted=true;eventHub.emit("ready",mapFeatureFlagsToFeatureFlagBaseList(store.getFeatureFlags()))}return[2]}})})};Ffc2.prototype.dataSync=function(){return ffc_awaiter(this,void 0,void 0,function(){var _this=this;return ffc_generator(this,function(_a){return[2,new Promise(function(resolve,reject){var timestamp=Math.max.apply(Math,ffc_spreadArray(ffc_spreadArray([],Object.values(store.getFeatureFlags()).map(function(ff){return ff.timestamp}),false),[0],false));networkService.createConnection(timestamp,function(message){var _a2;if(message&&message.userKeyId===((_a2=_this._option.user)===null||_a2===void 0?void 0:_a2.id)){var featureFlags=message.featureFlags;switch(message.eventType){case StreamResponseEventType.full:case StreamResponseEventType.patch:var data={featureFlags:featureFlags.reduce(function(res,curr){var id=curr.id,variation=curr.variation,timestamp2=curr.timestamp,variationOptions=curr.variationOptions,sendToExperiment=curr.sendToExperiment;res[id]={id,variation,timestamp:timestamp2,variationOptions,sendToExperiment};return res},{})};if(message.eventType===StreamResponseEventType.full){store.setFullData(data);logger_logger.logDebug("synchonized with full data")}else{store.updateBulkFromRemote(data);logger_logger.logDebug("synchonized with partial data")}break;default:logger_logger.logDebug("invalid stream event type: "+message.eventType);break}}resolve()})})]})})};Ffc2.prototype.variation=function(key,defaultResult){return variationWithInsightBuffer(key,defaultResult)||defaultResult};Ffc2.prototype.boolVariation=function(key,defaultResult){var variation=variationWithInsightBuffer(key,defaultResult);return!!variation?variation.toLocaleLowerCase()==="true":defaultResult};Ffc2.prototype.getUser=function(){return ffc_assign({},this._option.user)};Ffc2.prototype.sendCustomEvent=function(data){var _this=this;(data||[]).forEach(function(d){return _this._insightsQueue.add(ffc_assign({insightType:InsightType.customEvent,type:"CustomEvent"},d))})};Ffc2.prototype.sendFeatureFlagInsight=function(key,variation){this.variation(key,variation)};Ffc2.prototype.getAllFeatureFlags=function(){var flags=store.getFeatureFlags();return Object.values(flags).reduce(function(acc,curr){acc[curr.id]=curr.variation;return acc},{})};return Ffc2}();var variationWithInsightBuffer=function(key,defaultResult){var variation=store.getVariation(key);if(variation===void 0){eventHub.emit(featureFlagEvaluatedBufferTopic,{id:key,timestamp:Date.now(),variationValue:"".concat(defaultResult)})}return variation};var ffcClient=new Ffc;const ffc=ffcClient;;const src=ffc;function fetchFlags(component){var configs=component.data.flagConfigs||[];var flags=configs.map(function(_a){var key=_a.key,defaultValue=_a.defaultValue;ffc.on("ff_update:".concat(key),function(){var _a2;var variation=ffc.variation(key,defaultValue);component.setData({flags:Object.assign({},component.data.flags,(_a2={},_a2[key]=variation,_a2))})});return{key,variation:ffc.variation(key,defaultValue)}}).reduce(function(acc,cur){acc[cur.key]=cur.variation;return acc},{});component.setData({flags})}var oldPage=Page;Page=function(options){var oldOnLoad=options.onLoad;options.onLoad=function(){fetchFlags(this);oldOnLoad&&oldOnLoad.call(this)};return oldPage(options)};var oldComponent=Component;Component=function(options){var oldAttached=options.attached;options.attached=function(){fetchFlags(this);oldAttached&&oldAttached.call(this)};if(options.lifetimes&&options.lifetimes.attached){options.lifetimes.attached=function(){fetchFlags(this);oldAttached&&oldAttached.call(this)}}return oldComponent(options)};return __webpack_exports__})()});
